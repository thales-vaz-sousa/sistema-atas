{% extends "base.html" %}
{% block title %}Ata Sacramental{% endblock %}

{% block content %}
<div class="card" style="max-width: 1200px;">
  <h1>Ata de Reuni√£o Sacramental</h1>
  <p class="subtitle">Preencha os campos abaixo</p>

  <form method="POST">
    <input type="hidden" name="tipo" value="sacramental">
    <input type="hidden" name="data" value="{{ data }}">
    {% if editar %}
    <input type="hidden" name="editar" value="{{ editar }}">
    {% endif %}

    <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 2rem;">
      
      <!-- COLUNA ESQUERDA - DISCURSANTES RECENTES -->
      <div>
        {% if not editar and discursantes_recentes and discursantes_recentes|length > 0 %}
        <div style="background: #f8f9fa; padding: 1.5rem; border-radius: var(--radius); border-left: 4px solid var(--accent-color);">
          <h3 style="color: var(--accent-color); margin-bottom: 1rem;">üìã Discursantes Recentes</h3>
          <p style="font-size: 0.9rem; color: #666; margin-bottom: 1rem;">
            Discursantes dos √∫ltimos 3 meses:
          </p>
          <div style="max-height: 400px; overflow-y: auto;">
            <ul style="list-style: none; padding: 0; margin: 0;">
              {% for discursante in discursantes_recentes %}
              <li style="padding: 0.75rem; background: white; margin-bottom: 0.5rem; border-radius: 6px; border: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center;">
                <span style="font-weight: 500;">{{ discursante.nome }}</span>
                <small style="color: #666; font-size: 0.8rem;">{{ discursante.data }}</small>
              </li>
              {% endfor %}
            </ul>
          </div>
          <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e2e8f0;">
            <small style="color: #666;">
              üí° Dica: Voc√™ pode copiar os nomes para o formul√°rio ao lado
            </small>
          </div>
        </div>
        {% endif %}
      </div>

      <!-- COLUNA DIREITA - FORMUL√ÅRIO -->
      <div>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
          <div>
            <label style="display:block; font-size:0.9rem; margin-bottom:0.3rem;">Presidido por</label>
            <input type="text" name="presidido" value="{{ dados.presidido or '' }}">
          </div>
          <div>
            <label style="display:block; font-size:0.9rem; margin-bottom:0.3rem;">Dirigido por</label>
            <input type="text" name="dirigido" value="{{ dados.dirigido or '' }}">
          </div>
          <div>
            <label style="display:block; font-size:0.9rem; margin-bottom:0.3rem;">Pianista</label>
            <input type="text" name="pianista" value="{{ dados.pianista or '' }}">
          </div>
          <div>
            <label style="display:block; font-size:0.9rem; margin-bottom:0.3rem;">Regente de M√∫sica</label>
            <input type="text" name="regente_musica" value="{{ dados.regente_musica or '' }}">
          </div>
          <div style="grid-column: 1 / -1;">
            <label style="display:block; font-size:0.9rem; margin-bottom:0.3rem;">An√∫ncios</label>
            <textarea name="anuncios[]" rows="3" style="width:100%; border-radius:var(--radius); padding:0.75rem; border:1px solid #ccc; font-family:inherit;" placeholder="Digite os an√∫ncios, um por linha">{{ dados.anuncios|join('\n') if dados.anuncios else '' }}</textarea>
          </div>
          <div>
            <label style="display:block; font-size:0.9rem; margin-bottom:0.3rem;">Hino de Abertura</label>
            <input type="text" name="hino_abertura" value="{{ dados.hino_abertura or '' }}">
          </div>
          <div>
            <label style="display:block; font-size:0.9rem; margin-bottom:0.3rem;">Ora√ß√£o de Abertura</label>
            <input type="text" name="oracao_abertura" value="{{ dados.oracao_abertura or '' }}">
          </div>
          <div>
            <label style="display:block; font-size:0.9rem; margin-bottom:0.3rem;">Hino Sacramental</label>
            <input type="text" name="hino_sacramental" value="{{ dados.hino_sacramental or '' }}">
          </div>
          <div>
            <label style="display:block; font-size:0.9rem; margin-bottom:0.3rem;">Hino Intermedi√°rio</label>
            <input type="text" name="hino_intermediario" value="{{ dados.hino_intermediario or '' }}">
          </div>
          <div>
            <label style="display:block; font-size:0.9rem; margin-bottom:0.3rem;">Hino de Encerramento</label>
            <input type="text" name="hino_encerramento" value="{{ dados.hino_encerramento or '' }}">
          </div>
          <div>
            <label style="display:block; font-size:0.9rem; margin-bottom:0.3rem;">Ora√ß√£o de Encerramento</label>
            <input type="text" name="oracao_encerramento" value="{{ dados.oracao_encerramento or '' }}">
          </div>
        </div>

       <!-- SE√á√ÉO DE DISCURSANTES COM CAMPOS DIN√ÇMICOS -->
<div style="margin-bottom: 2rem; padding: 1.5rem; background: #f8f9fa; border-radius: var(--radius);">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
    <h3 style="color: var(--accent-color); margin: 0;">üé§ Discursantes</h3>
    <button type="button" onclick="addDiscursante()" style="background: #666; color: white; border: none; padding: 0.5rem 1rem; border-radius: var(--radius); cursor: pointer; font-size: 0.9rem;">
      + Adicionar Discursante
    </button>
  </div>
  
  <div id="discursantes-container">
    {% if dados.discursantes and dados.discursantes|length > 0 %}
      {% for discursante in dados.discursantes %}
        {% if discursante and discursante.strip() %}
        <div class="discursante-field">
          <input type="text" name="discursantes[]" value="{{ discursante }}" placeholder="Nome do discursante">
          <button type="button" onclick="removeDiscursante(this)" class="remove-btn">√ó</button>
        </div>
        {% endif %}
      {% endfor %}
    {% else %}
      <!-- Campos iniciais -->
      <div class="discursante-field">
        <input type="text" name="discursantes[]" placeholder="1¬∫ Discursante">
        <button type="button" onclick="removeDiscursante(this)" class="remove-btn">√ó</button>
      </div>
      <div class="discursante-field">
        <input type="text" name="discursantes[]" placeholder="2¬∫ Discursante">
        <button type="button" onclick="removeDiscursante(this)" class="remove-btn">√ó</button>
      </div>
      <div class="discursante-field">
        <input type="text" name="discursantes[]" placeholder="3¬∫ Discursante">
        <button type="button" onclick="removeDiscursante(this)" class="remove-btn">√ó</button>
      </div>
    {% endif %}
  </div>
  
  <small style="color: #666; display: block; margin-top: 0.5rem;">
    üí° Adicione quantos discursantes forem necess√°rios
  </small>
</div>

        <!-- BOT√ïES DE A√á√ÉO -->
        <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
          <button type="submit" style="flex:1; min-width:200px;">
            üíæ {% if editar %}Atualizar{% else %}Salvar{% endif %} Ata
          </button>
          {% if editar %}
          <a href="{{ url_for('visualizar_ata', ata_id=editar) }}" style="flex:1; min-width:200px; padding:0.75rem 1rem; border-radius:var(--radius); background:#999; color:#fff; text-decoration:none; text-align:center;">
            ‚ùå Cancelar
          </a>
          {% else %}
          <a href="{{ url_for('nova_ata') }}" style="flex:1; min-width:200px; padding:0.75rem 1rem; border-radius:var(--radius); background:#666; color:#fff; text-decoration:none; text-align:center;">
            üìÑ Nova Ata
          </a>
          <a href="{{ url_for('index') }}" style="flex:1; min-width:200px; padding:0.75rem 1rem; border-radius:var(--radius); background:#999; color:#fff; text-decoration:none; text-align:center;">
            üè† Cancelar
          </a>
          {% endif %}
        </div>
      </div>
    </div>
  </form>
</div>

<script>
let discursanteCount = {{ dados.discursantes|length if dados.discursantes else 3 }};

function addDiscursante() {
    const container = document.getElementById('discursantes-container');
    const newDiv = document.createElement('div');
    newDiv.className = 'discursante-field';
    
    discursanteCount++;
    
    const input = document.createElement('input');
    input.type = 'text';
    input.name = 'discursantes[]';
    input.placeholder = discursanteCount + '¬∫ Discursante';
    
    const button = document.createElement('button');
    button.type = 'button';
    button.className = 'remove-btn';
    button.textContent = '√ó';
    button.onclick = function() { removeDiscursante(this); };
    
    newDiv.appendChild(input);
    newDiv.appendChild(button);
    container.appendChild(newDiv);
}

function removeDiscursante(button) {
    const container = document.getElementById('discursantes-container');
    const inputs = container.querySelectorAll('input[name="discursantes[]"]');
    
    // S√≥ remove se houver mais de um campo
    if (inputs.length > 1) {
        button.parentElement.remove();
        // Atualiza os placeholders
        updateDiscursantePlaceholders();
    }
}

function updateDiscursantePlaceholders() {
    const inputs = document.querySelectorAll('input[name="discursantes[]"]');
    inputs.forEach(function(input, index) {
        input.placeholder = (index + 1) + '¬∫ Discursante';
    });
    discursanteCount = inputs.length;
}
</script>

<style>
@media (max-width: 768px) {
    .card > form > div {
        grid-template-columns: 1fr !important;
    }
}

/* Estilo para scrollbar da lista de discursantes recentes */
div[style*="max-height: 400px"]::-webkit-scrollbar {
    width: 6px;
}

div[style*="max-height: 400px"]::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 3px;
}

div[style*="max-height: 400px"]::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 3px;
}

div[style*="max-height: 400px"]::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

.discursante-field {
  margin-bottom: 1rem;
  display: flex;
  gap: 0.5rem;
  align-items: center;
}

.discursante-field input {
  flex: 1;
  padding: 0.75rem;
  font-size: 1rem;
  height: 48px;
  border: 1px solid #ccc;
  border-radius: var(--radius);
}

.remove-btn {
  background: #dc3545;
  color: white;
  border: none;
  width: 36px;
  height: 36px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 1rem;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  transition: background 0.2s ease;
}

.remove-btn:hover {
  background: #c82333;
}

</style>
{% endblock %}