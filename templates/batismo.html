{% extends "base.html" %}

{% block content %}
<div class="content-card">
    <h1>{% if editar %}Editar{% else %}Novo{% endif %} Serviço Batismal {{ data }}</h1>
    
    <div class="users-count" id="users-count">Usuários editando: 0</div>

    <form method="POST">
        <input type="hidden" name="tipo" value="batismo">
        <input type="hidden" name="data" value="{{ data }}">
        {% if editar %}
        <input type="hidden" name="editar" value="{{ editar }}">
        {% endif %}
        
        <div class="form-group">
            <input type="text" name="presidido" placeholder="Presidido por" 
                   value="{{ dados.presidido if dados and dados.presidido else '' }}" 
                   oninput="syncField(this)">
        </div>
        
        <div class="form-group">
            <input type="text" name="dirigido" placeholder="Dirigido por" 
                   value="{{ dados.dirigido if dados and dados.dirigido else '' }}" 
                   oninput="syncField(this)">
        </div>
        
        <div class="form-group">
            <input type="text" name="dedicado" placeholder="Dedicado a" 
                   value="{{ dados.dedicado if dados and dados.dedicado else '' }}" 
                   oninput="syncField(this)">
        </div>

        <h3>👥 Pessoas a serem batizadas</h3>
        <div id="batizados" class="dynamic-list">
            {% if dados and dados.batizados %}
                {% for batizado in dados.batizados %}
                    {% if batizado and batizado.strip() %}
                    <div class="form-group">
                        <input type="text" name="batizados[]" placeholder="Nome do Batizado" 
                               value="{{ batizado }}" oninput="syncField(this)">
                    </div>
                    {% endif %}
                {% endfor %}
            {% endif %}
            <!-- Campo vazio para novo batizado -->
            <div class="form-group">
                <input type="text" name="batizados[]" placeholder="Nome do Batizado" oninput="syncField(this)">
            </div>
        </div>
        
        <button type="button" onclick="addBatizado()" class="btn btn-secondary">+ Adicionar Pessoa</button>

        <h3 style="margin-top: 2rem;">👥 Testemunhas</h3>
        <div class="form-group">
            <input type="text" name="testemunha1" placeholder="Testemunha 1" 
                   value="{{ dados.testemunha1 if dados and dados.testemunha1 else '' }}" 
                   oninput="syncField(this)">
        </div>
        
        <div class="form-group">
            <input type="text" name="testemunha2" placeholder="Testemunha 2" 
                   value="{{ dados.testemunha2 if dados and dados.testemunha2 else '' }}" 
                   oninput="syncField(this)">
        </div>

        <div class="form-actions">
            <button type="submit" class="btn">{% if editar %}💾 Atualizar{% else %}💾 Salvar{% endif %} Ata</button>
            {% if editar %}
            <a href="{{ url_for('visualizar_ata', ata_id=editar) }}" class="btn btn-secondary">❌ Cancelar</a>
            {% else %}
            <a href="{{ url_for('nova_ata') }}" class="btn btn-secondary">📄 Nova Ata</a>
            <a href="{{ url_for('index') }}" class="btn btn-secondary">🏠 Cancelar</a>
            {% endif %}
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
<script>
const socket = io();
const ataId = "{{ data }}";
socket.emit('join', { ata_id: ataId });

socket.on('update_users', (data) => {
    document.getElementById('users-count').innerText = "Usuários editando: " + data.count;
});

function syncField(el) {
    socket.emit('field_update', { ata_id: ataId, name: el.name, value: el.value });
}

socket.on('field_update', (data) => {
    const field = document.querySelector(`[name="${data.name}"]`);
    if (field && field.value !== data.value) {
        field.value = data.value;
    }
});

window.addEventListener('beforeunload', () => {
    socket.emit('leave', { ata_id: ataId });
});

function addBatizado() {
    const div = document.getElementById('batizados');
    const inputDiv = document.createElement('div');
    inputDiv.className = 'form-group';
    inputDiv.innerHTML = '<input type="text" name="batizados[]" placeholder="Nome do Batizado" oninput="syncField(this)">';
    div.appendChild(inputDiv);
}

// Preencher campos com dados existentes quando em modo de edição
{% if editar and dados %}
document.addEventListener('DOMContentLoaded', function() {
    console.log('Modo edição ativado para ata {{ editar }}');
});
{% endif %}
</script>
{% endblock %}